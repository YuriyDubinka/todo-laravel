name: Laravel Tests

on: [push, pull_request]

jobs:
  laravel-tests:
    # Ğ’Ñ–Ñ€Ñ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ° Ğ¼Ğ°ÑˆĞ¸Ğ½Ğ°, Ğ½Ğ° ÑĞºÑ–Ğ¹ Ğ²ÑĞµ Ğ±ÑƒĞ´Ğµ Ğ²Ñ–Ğ´Ğ±ÑƒĞ²Ğ°Ñ‚Ğ¸ÑÑ
    runs-on: ubuntu-latest

    steps:
      # 1. Ğ¡ĞºĞ°Ñ‡ÑƒÑ”Ğ¼Ğ¾ Ñ‚Ğ²Ñ–Ğ¹ ĞºĞ¾Ğ´ Ğ· Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ñ–Ñ
      - uses: actions/checkout@v4

      # 2. Ğ’ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ PHP (ÑĞº Ğ¼Ğ¸ Ñ€Ğ¾Ğ±Ğ¸Ğ»Ğ¸ Ğ½Ğ° Ñ‚Ğ²Ğ¾Ñ”Ğ¼Ñƒ Mac, Ğ°Ğ»Ğµ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡Ğ½Ğ¾)
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.3" # ĞĞ±Ğ¾ 8.2, Ğ·Ğ°Ğ»ĞµĞ¶Ğ½Ğ¾ Ğ²Ñ–Ğ´ Ñ‚Ğ¾Ğ³Ğ¾, Ñ‰Ğ¾ Ñƒ Ñ‚ĞµĞ±Ğµ Ğ² composer.json
          extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, bcmath, soap, intl, gd, exif, iconv
          coverage: none

      # 3. Ğ’ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ·Ğ°Ğ»ĞµĞ¶Ğ½Ğ¾ÑÑ‚Ñ– (Vendor)
      - name: Install Dependencies
        run: composer install -q --no-ansi --no-interaction --no-scripts --no-progress --prefer-dist

      # 4. ĞĞ°Ğ»Ğ°ÑˆÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ ÑĞµÑ€ĞµĞ´Ğ¾Ğ²Ğ¸Ñ‰Ğµ (.env)
      - name: Copy .env
        run: cp .env.example .env

      # 5. Ğ“ĞµĞ½ĞµÑ€ÑƒÑ”Ğ¼Ğ¾ ĞºĞ»ÑÑ‡ ÑˆĞ¸Ñ„Ñ€ÑƒĞ²Ğ°Ğ½Ğ½Ñ
      - name: Generate Key
        run: php artisan key:generate

      # 6. Ğ¡Ñ‚Ğ²Ğ¾Ñ€ÑÑ”Ğ¼Ğ¾ Ğ¿Ğ¾Ñ€Ğ¾Ğ¶Ğ½Ñ Ğ±Ğ°Ğ·Ñƒ Ğ´Ğ°Ğ½Ğ¸Ñ… (SQLite) Ğ´Ğ»Ñ Ñ‚ĞµÑÑ‚Ñ–Ğ²
      # Ğ”Ğ»Ñ CI Ñ‚ĞµÑÑ‚Ñ–Ğ² SQLite ÑˆĞ²Ğ¸Ğ´ÑˆĞµ Ñ– Ğ¿Ñ€Ğ¾ÑÑ‚Ñ–ÑˆĞµ, Ğ½Ñ–Ğ¶ Ğ¿Ñ–Ğ´Ğ½Ñ–Ğ¼Ğ°Ñ‚Ğ¸ MySQL ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€
      - name: Create Database
        run: |
          mkdir -p database
          touch database/database.sqlite

      # 7. Ğ’ĞºĞ°Ğ·ÑƒÑ”Ğ¼Ğ¾ Laravel Ğ²Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒĞ²Ğ°Ñ‚Ğ¸ SQLite Ğ´Ğ»Ñ Ñ‚ĞµÑÑ‚Ñ–Ğ²
      - name: Set Environment Variables
        run: |
          echo "DB_CONNECTION=sqlite" >> .env
          echo "DB_DATABASE=database/database.sqlite" >> .env

      # 8. Ğ—ĞĞŸĞ£Ğ¡Ğš Ğ¢Ğ•Ğ¡Ğ¢Ğ†Ğ’ ğŸš€
      - name: Execute tests (Unit and Feature tests) via Pest/PHPUnit
        run: php artisan test
