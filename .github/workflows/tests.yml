name: CI/CD (Full Test Suite)

on: [push, pull_request]

jobs:
  tests:
    runs-on: ubuntu-latest

    # üî• –ì–õ–û–ë–ê–õ–¨–ù–Ü –ó–ú–Ü–ù–ù–Ü üî•
    # –ú–∏ –æ–≥–æ–ª–æ—à—É—î–º–æ —ó—Ö —Ç—É—Ç –û–î–ò–ù –†–ê–ó.
    # –í—Å—ñ –∫—Ä–æ–∫–∏ –Ω–∏–∂—á–µ (server, migrate, tests) –±—É–¥—É—Ç—å –±–∞—á–∏—Ç–∏ –æ–¥–Ω—É –π —Ç—É —Å–∞–º—É –±–∞–∑—É.
    env:
      DB_CONNECTION: sqlite
      DB_DATABASE: ${{ github.workspace }}/database/database.sqlite
      APP_ENV: local
      APP_KEY: base64:OpnM6+4+7qXk5w8jT/I0g5u3K7y+1v1h2j3k4l5m6n7= # –¢–∏–º—á–∞—Å–æ–≤–∏–π –∫–ª—é—á –¥–ª—è CI, —â–æ–± –Ω–µ –≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏

    steps:
      - uses: actions/checkout@v4

      # 1. –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞ (PHP + Node)
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.4"
          extensions: sqlite, pdo_sqlite, dom, curl, libxml, mbstring, zip
          coverage: none

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # 2. –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ñ–∞–π–ª—ñ–≤
      - name: Prepare Application
        run: |
          cp .env.example .env
          mkdir -p database
          touch database/database.sqlite

          # –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ
          composer install -q --no-ansi --no-interaction --no-scripts --no-progress --prefer-dist
          npm ci
          npm run build

          # –ì–µ–Ω–µ—Ä—É—î–º–æ –∫–ª—é—á –¥–æ–¥–∞—Ç–∫–∞ (–ø–µ—Ä–µ–∑–∞–ø–∏—Å—É—î–º–æ —Ç–æ–π, —â–æ –≤ env)
          php artisan key:generate

      # 3. –ë–∞–∑–∞ –¥–∞–Ω–∏—Ö (–ú—ñ–≥—Ä–∞—Ü—ñ—ó + –°—ñ–¥–µ—Ä)
      - name: Migrate & Seed
        run: php artisan migrate:fresh --seed --force

      # 4. PHP –¢–µ—Å—Ç–∏
      - name: Run Backend Tests (Pest)
        run: php artisan test

      # 5. Playwright (E2E)
      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      - name: Start Laravel Server
        run: |
          # –ó–∞–ø—É—Å–∫–∞—î–º–æ —Å–µ—Ä–≤–µ—Ä –Ω–∞ 127.0.0.1, —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ –ø—Ä–æ–±–ª–µ–º –∑ localhost
          php artisan serve --host=127.0.0.1 --port=8000 &
          sleep 5

      - name: Run E2E Tests (Playwright)
        run: npx playwright test
        env:
          # –í–∫–∞–∑—É—î–º–æ Playwright, –∫—É–¥–∏ —Å—Ç—É–∫–∞—Ç–∏
          BASE_URL: http://127.0.0.1:8000

      # 6. –ó–≤—ñ—Ç –ø—Ä–∏ –ø–æ–º–∏–ª—Ü—ñ
      - name: Upload Report
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7
